<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacAttack-Web v3.0 - Enhanced Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: #16213e;
            --bg-input: #0f3460;
            --bg-tertiary: #2c3e50;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --accent: #e94560;
            --success: #00d26a;
            --warning: #ffc107;
            --error: #ff4757;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; border-bottom: 2px solid var(--accent);
        }
        header h1 { font-size: 2rem; }
        .version { color: var(--text-secondary); font-size: 0.9rem; }
        .tabs { display: flex; gap: 5px; margin: 20px 0; flex-wrap: wrap; }
        .tab-btn {
            padding: 12px 24px; background: var(--bg-panel); border: none;
            color: var(--text-primary); cursor: pointer; border-radius: 8px 8px 0 0;
            transition: all 0.3s;
        }
        .tab-btn:hover { background: var(--bg-input); }
        .tab-btn.active { background: var(--accent); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .panel {
            background: var(--bg-panel); padding: 20px; border-radius: 10px;
            margin-bottom: 20px;
        }
        .panel h2 { margin-bottom: 15px; font-size: 1.2rem; color: var(--accent); }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 12px; background: var(--bg-input);
            border: 1px solid transparent; border-radius: 6px;
            color: var(--text-primary); font-size: 1rem;
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none; border-color: var(--accent);
        }
        .form-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 200px; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .checkbox-group input { width: auto; }
        .checkbox-group label { margin: 0; }
        .btn {
            padding: 12px 24px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 1rem; transition: all 0.3s;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        .btn-danger { background: var(--error); color: white; }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card {
            background: var(--bg-panel); padding: 20px; border-radius: 10px;
            text-align: center; border-left: 4px solid var(--accent);
        }
        .stat-card.success { border-color: var(--success); }
        .stat-card.error { border-color: var(--error); }
        .stat-label { display: block; color: var(--text-secondary); font-size: 0.9rem; }
        .stat-value { display: block; font-size: 2rem; font-weight: bold; margin-top: 5px; }
        .two-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .two-columns { grid-template-columns: 1fr; } }
        .log-box {
            background: var(--bg-input); border-radius: 6px; padding: 15px;
            height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9rem;
        }
        .log-entry { padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--error); }
        .log-entry.warning { color: var(--warning); }
        .log-entry .time { color: var(--text-secondary); margin-right: 10px; }
        
        /* Additional styles for new features */
        .radio-group { display: flex; gap: 20px; flex-wrap: wrap; }
        .radio-group label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .radio-group input[type="radio"] { width: auto; }

        .info-panel { background: var(--bg-input); }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .info-row:last-child { border-bottom: none; }
        .info-row span:first-child { color: var(--text-secondary); }
        .info-row span:last-child { font-family: monospace; color: var(--accent); }

        .help-text { background: rgba(233, 69, 96, 0.1); padding: 15px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; line-height: 1.6; }
        .help-text strong { color: var(--accent); }

        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; }
        .status-badge.enabled { background: var(--success); color: white; }
        .status-badge.disabled { background: var(--text-secondary); color: white; }

        .btn-small { padding: 6px 12px; font-size: 0.85rem; }

        input[type="file"] { padding: 10px; background: var(--bg-input); border-radius: 6px; }

        /* Multi-Portal Attack Styles */
        .attack-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; background: var(--bg-input); border-radius: 6px;
            margin-bottom: 10px; cursor: pointer; transition: all 0.2s;
            border-left: 4px solid var(--success);
        }
        .attack-item:hover { background: rgba(255,255,255,0.1); }
        .attack-item.selected { border-color: var(--accent); background: rgba(233, 69, 96, 0.2); }
        .attack-item.finished { border-color: var(--text-secondary); opacity: 0.7; }
        .attack-info { flex: 1; }
        .attack-url { display: block; font-weight: bold; margin-bottom: 5px; word-break: break-all; }
        .attack-stats { font-size: 0.85rem; color: var(--text-secondary); }
        .attack-actions { display: flex; gap: 5px; }
        .no-attacks { text-align: center; padding: 30px; color: var(--text-secondary); }

        textarea {
            width: 100%; height: 200px; resize: vertical;
            background: var(--bg-input); border: 1px solid transparent;
            border-radius: 6px; padding: 15px; color: var(--text-primary);
            font-family: monospace;
        }
        textarea:focus { outline: none; border-color: var(--accent); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: var(--bg-input); color: var(--accent); }
        tr:hover { background: rgba(255,255,255,0.05); }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-paused {
            background: var(--warning);
        }

        .status-stopped {
            background: var(--error);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .current-status {
            background: var(--bg-panel);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .current-mac {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: var(--accent);
        }

        .current-proxy {
            font-family: 'Courier New', monospace;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ MacAttack-Web</h1>
            <span class="version">v3.0 - Enhanced Edition</span>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="attack">Mac Attack</button>
            <button class="tab-btn" data-tab="portals">Portals</button>
            <button class="tab-btn" data-tab="maclist">MAC List</button>
            <button class="tab-btn" data-tab="proxies">Proxies</button>
            <button class="tab-btn" data-tab="found">Found MACs</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
        </nav>

        <!-- MAC ATTACK TAB -->
        <div id="attack" class="tab-content active">
            <div class="current-status">
                <div>
                    <span class="status-indicator" id="statusIndicator"></span>
                    <strong>Status:</strong> <span id="scannerStatus">Stopped</span>
                </div>
                <div>
                    <strong>Current MAC:</strong> <span class="current-mac" id="currentMac">-</span>
                </div>
                <div>
                    <strong>Current Proxy:</strong> <span class="current-proxy" id="currentProxy">-</span>
                </div>
                <div>
                    <strong>Connection:</strong> <span id="connectionStatus">üî¥ Connecting...</span>
                </div>
            </div>

            <div class="panel">
                <h2>Portal Configuration</h2>
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label>Portal URL:</label>
                        <input type="text" id="attack-url" placeholder="http://example.com/portal.php">
                    </div>
                    <div class="form-group">
                        <label>Or select saved:</label>
                        <select id="attack-portal-select">
                            <option value="">-- Select Portal --</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Attack Mode:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="attack-mode" value="random" checked> Random MAC Generation</label>
                        <label><input type="radio" name="attack-mode" value="list"> Use MAC List</label>
                        <label><input type="radio" name="attack-mode" value="refresh"> Refresh Found MACs (<span id="found-mac-count">0</span> MACs)</label>
                    </div>
                </div>
                <div class="form-row" id="mac-list-select-row" style="display: none;">
                    <div class="form-group">
                        <label>Select MAC List:</label>
                        <select id="attack-mac-list">
                            <option value="1">List 1 (<span id="mac-list-1-count">0</span> MACs)</option>
                            <option value="2">List 2 (<span id="mac-list-2-count">0</span> MACs)</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button id="btn-start" class="btn btn-success">‚ñ∂ Start Attack</button>
                    <button id="btn-start-multi" class="btn btn-primary">‚ñ∂ Start All Enabled Portals</button>
                    <button id="btn-stop-all" class="btn btn-danger">‚èπ Stop All</button>
                    <button id="btn-pause" class="btn btn-warning">‚è∏ Pause</button>
                    <button id="btn-clear-finished" class="btn btn-secondary">Clear Finished</button>
                </div>
            </div>

            <!-- Running Attacks Overview -->
            <div class="panel" id="attacks-overview">
                <h2>Running Attacks</h2>
                <div id="attacks-list">
                    <div class="no-attacks">No attacks running</div>
                </div>
            </div>

            <!-- Selected Attack Details -->
            <div id="attack-details">
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-label">Tested</span>
                        <span class="stat-value" id="stat-tested">0</span>
                        <span class="stat-label">Rate: <span id="testRate">0/s</span></span>
                    </div>
                    <div class="stat-card success">
                        <span class="stat-label">Hits</span>
                        <span class="stat-value" id="stat-hits">0</span>
                        <span class="stat-label">Rate: <span id="hitRate">0%</span></span>
                    </div>
                    <div class="stat-card error">
                        <span class="stat-label">Errors</span>
                        <span class="stat-value" id="stat-errors">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Time</span>
                        <span class="stat-value" id="stat-time">00:00</span>
                    </div>
                </div>

                <div class="panel info-panel">
                    <div class="info-row">
                        <span>Portal:</span>
                        <span id="current-portal">-</span>
                    </div>
                    <div class="info-row">
                        <span>MAC Prefix:</span>
                        <span id="current-prefix">-</span>
                    </div>
                    <div class="info-row" id="list-progress-row" style="display: none;">
                        <span>List Progress:</span>
                        <span id="list-progress">0 / 0</span>
                    </div>
                    <div class="info-row">
                        <span>Retry Queue:</span>
                        <span id="retryQueue">0</span>
                    </div>
                    <div class="info-row">
                        <span>MAC Coverage:</span>
                        <span id="macCoverage">0%</span>
                    </div>
                </div>

                <div class="two-columns">
                    <div class="panel">
                        <h2>Recent Hits</h2>
                        <div class="log-box" id="found-list">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                No hits yet. Start scanning to find valid MACs!
                            </div>
                        </div>
                    </div>
                    <div class="panel">
                        <h2>Live Log</h2>
                        <div class="log-box" id="attack-log">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                Logs will appear here when scanner starts.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PORTALS TAB -->
        <div id="portals" class="tab-content">
            <div class="panel">
                <h2>Add New Portal</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Portal Name:</label>
                        <input type="text" id="portal-name" placeholder="My Portal">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Portal URL:</label>
                        <input type="text" id="portal-url" placeholder="http://example.com/portal.php">
                    </div>
                </div>
                <button id="btn-add-portal" class="btn btn-success">Add Portal</button>
            </div>

            <div class="panel">
                <h2>Saved Portals</h2>
                <div class="help-text">
                    <strong>Portal URL Format:</strong> http://hostname:port/portal.php oder http://hostname:port/stalker_portal/server/load.php
                </div>
                <table id="portals-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>URL</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="portals-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- MAC LIST TAB -->
        <div id="maclist" class="tab-content">
            <div class="panel">
                <h2>Import MAC List</h2>
                <div class="help-text">
                    Import a list of MAC addresses to test. One MAC per line.<br>
                    <strong>Supported formats:</strong> 00:1A:79:XX:XX:XX, 00-1A-79-XX-XX-XX<br>
                    <strong>Max file size:</strong> 500 MB
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Target List:</label>
                        <select id="import-target-list">
                            <option value="1">List 1</option>
                            <option value="2">List 2</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Upload File: <span id="file-info" style="color: var(--text-secondary);"></span></label>
                        <input type="file" id="mac-file-input" accept=".txt,.csv">
                    </div>
                </div>
                <div id="import-progress" style="display: none; margin-bottom: 15px;">
                    <div style="background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div id="import-progress-bar" style="height: 20px; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="import-status" style="margin-top: 5px; color: var(--text-secondary);"></div>
                </div>
                <button id="btn-import-file" class="btn btn-primary">Import from File</button>
            </div>

            <div class="two-columns">
                <div class="panel">
                    <h2>MAC List 1 (<span id="maclist-count-1">0</span>)</h2>
                    <textarea id="mac-list-textarea-1" placeholder="Enter MAC addresses (one per line)&#10;00:1A:79:XX:XX:XX"></textarea>
                    <div class="button-group">
                        <button class="btn btn-success btn-save-maclist" data-list="1">Save List 1</button>
                        <button class="btn btn-danger btn-clear-maclist" data-list="1">Clear</button>
                    </div>
                </div>
                <div class="panel">
                    <h2>MAC List 2 (<span id="maclist-count-2">0</span>)</h2>
                    <textarea id="mac-list-textarea-2" placeholder="Enter MAC addresses (one per line)&#10;00:1A:79:XX:XX:XX"></textarea>
                    <div class="button-group">
                        <button class="btn btn-success btn-save-maclist" data-list="2">Save List 2</button>
                        <button class="btn btn-danger btn-clear-maclist" data-list="2">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROXIES TAB -->
        <div id="proxies" class="tab-content">
            <div class="panel">
                <h2>Proxy Management</h2>
                <div class="help-text">
                    <strong>Supported Proxy Types:</strong> HTTP (ip:port), SOCKS4 (socks4://ip:port), SOCKS5 (socks5://ip:port, socks5://user:pass@ip:port)
                </div>
                <div class="button-group">
                    <button id="btn-fetch-proxies" class="btn btn-primary">Fetch Proxies</button>
                    <button id="btn-test-proxies" class="btn btn-warning">Test Proxies</button>
                    <button id="btn-test-autodetect" class="btn btn-info" title="Tests each proxy as HTTP, then SOCKS5, then SOCKS4 and updates the type">Test & Auto-Detect</button>
                    <button id="btn-remove-failed" class="btn btn-danger" title="Remove proxies that failed the last test">Remove Failed</button>
                    <button id="btn-reset-errors" class="btn btn-secondary">Reset Errors</button>
                    <button id="btn-clear-proxies" class="btn btn-danger">Clear All</button>
                </div>
            </div>

            <div class="panel">
                <h2>Custom Proxy Sources</h2>
                <div class="help-text">
                    Add your own proxy list URLs. Proxies will be fetched as ip:port format.<br>
                    Use "Test & Auto-Detect" after fetching to determine the correct proxy type.
                </div>
                <textarea id="proxy-sources" placeholder="Enter proxy source URLs (one per line)&#10;https://example.com/proxy-list.txt" style="height: 100px;"></textarea>
                <button id="btn-save-sources" class="btn btn-success">Save Sources</button>
            </div>

            <div class="panel">
                <h2>Import Proxies</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Default Proxy Type for ip:port format:</label>
                        <select id="proxy-import-type">
                            <option value="http">HTTP (default)</option>
                            <option value="socks4">SOCKS4</option>
                            <option value="socks5">SOCKS5</option>
                        </select>
                    </div>
                </div>
                <div class="help-text">
                    Paste proxies below (ip:port format). The selected type will be auto-applied.<br>
                    Proxies with existing prefix (socks4://, socks5://) will keep their type.
                </div>
                <textarea id="proxy-import-textarea" placeholder="Paste proxies here (one per line)&#10;192.168.1.1:8080&#10;10.0.0.1:1080"></textarea>
                <button id="btn-import-proxies" class="btn btn-success">Import & Add to List</button>
            </div>

            <div class="two-columns">
                <div class="panel">
                    <h2>Proxies (<span id="proxy-count">0</span>)</h2>
                    <textarea id="proxy-list" placeholder="Enter proxies (one per line)&#10;Format: ip:port or socks5://ip:port"></textarea>
                    <button id="btn-save-proxies" class="btn btn-success">Save Proxies</button>
                </div>
                <div class="panel">
                    <h2>Proxy Statistics</h2>
                    <div class="log-box" id="proxy-stats-list">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            No proxy statistics available yet.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOUND MACS TAB -->
        <div id="found" class="tab-content">
            <div class="panel">
                <h2>Found MAC Addresses</h2>
                <div class="button-group">
                    <button id="btn-export-txt" class="btn btn-primary">Export TXT</button>
                    <button id="btn-export-json" class="btn btn-secondary">Export JSON</button>
                    <button id="btn-clear-found" class="btn btn-danger">Clear All</button>
                </div>
            </div>

            <div class="panel">
                <table id="found-table">
                    <thead>
                        <tr>
                            <th>MAC Address</th>
                            <th>Expiry</th>
                            <th>Channels</th>
                            <th>DE</th>
                            <th>Portal</th>
                            <th>Genres</th>
                            <th>Found At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="found-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="panel">
                <h2>Attack Settings</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Max Workers:</label>
                        <input type="number" id="setting-max-workers" min="1" max="200" value="50">
                    </div>
                    <div class="form-group">
                        <label>Timeout (seconds):</label>
                        <input type="number" id="setting-timeout" min="1" max="60" value="15">
                    </div>
                    <div class="form-group">
                        <label>MAC Prefix:</label>
                        <input type="text" id="setting-prefix" value="00:1A:79">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Chunk Size:</label>
                        <input type="number" id="setting-chunk-size" min="10" max="10000" value="1000">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="setting-auto-save" checked>
                        <label for="setting-auto-save">Auto-save found MACs</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="setting-debug-mode">
                        <label for="setting-debug-mode">Debug Mode (requires restart)</label>
                    </div>
                </div>
                <button id="btn-save-settings" class="btn btn-success">Save Settings</button>
            </div>

            <div class="panel">
                <h2>Performance Settings</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Connections per Host:</label>
                        <input type="number" id="setting-connections-per-host" min="1" max="50" value="5">
                        <small style="color: var(--text-secondary);">Max simultaneous connections per portal (lower = safer)</small>
                    </div>
                    <div class="form-group">
                        <label>Requests/Min per Proxy:</label>
                        <input type="number" id="setting-requests-per-minute" min="5" max="120" value="30">
                        <small style="color: var(--text-secondary);">Max requests per minute per proxy</small>
                    </div>
                    <div class="form-group">
                        <label>Min Delay (seconds):</label>
                        <input type="number" id="setting-min-delay" min="0.1" max="5" step="0.1" value="0.5">
                        <small style="color: var(--text-secondary);">Minimum delay between requests per proxy</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Max Retries:</label>
                        <input type="number" id="setting-max-retries" min="1" max="10" value="3">
                        <small style="color: var(--text-secondary);">Max retry attempts per MAC</small>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="setting-quickscan-only">
                        <label for="setting-quickscan-only">QuickScan Only (faster)</label>
                        <small style="color: var(--text-secondary); display: block; margin-left: 25px;">Only check token + channels, skip detailed info</small>
                    </div>
                </div>
                <button id="btn-save-performance-settings" class="btn btn-success">Save Performance Settings</button>
            </div>

            <div class="panel">
                <h2>Authentication</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>Current Password:</label>
                        <input type="password" id="auth-current-password" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label>New Password:</label>
                        <input type="password" id="auth-new-password" placeholder="Enter new password">
                    </div>
                </div>
                <div class="button-group">
                    <button id="btn-update-password" class="btn btn-primary">Update Password</button>
                    <button id="btn-logout" class="btn btn-warning">üö™ Logout</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        
        // State variables
        let isRunning = false;
        let isPaused = false;
        let selectedAttackId = null;

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to server');
            document.getElementById('connectionStatus').textContent = 'üü¢ Connected';
            socket.emit('request_update');
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            document.getElementById('connectionStatus').textContent = 'üî¥ Disconnected';
        });

        socket.on('reconnect', function() {
            console.log('Reconnected to server');
            document.getElementById('connectionStatus').textContent = 'üü¢ Reconnected';
            socket.emit('request_update');
        });

        socket.on('scanner_update', function(data) {
            updateDashboard(data);
        });

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                
                if (btn.dataset.tab === 'portals') loadPortals();
                if (btn.dataset.tab === 'maclist') loadMacLists();
                if (btn.dataset.tab === 'found') loadFoundMacs();
                if (btn.dataset.tab === 'proxies') { loadProxySources(); loadProxyList(); }
                if (btn.dataset.tab === 'settings') loadSettings();
            });
        });

        // Show/hide MAC list selector based on mode
        document.querySelectorAll('input[name="attack-mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const listSelectRow = document.getElementById('mac-list-select-row');
                listSelectRow.style.display = e.target.value === 'list' ? 'flex' : 'none';
            });
        });

        // Generic API call with error handling
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showErrorMessage(`API Error: ${error.message}`);
                throw error;
            }
        }

        // Show error message to user
        function showErrorMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--error);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 5000);
        }

        // Show success message to user
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                word-wrap: break-word;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // Update dashboard with new data
        function updateDashboard(data) {
            // Update stats
            document.getElementById('stat-tested').textContent = data.tested || 0;
            document.getElementById('stat-hits').textContent = data.hits || 0;
            document.getElementById('testRate').textContent = data.test_rate || '0/s';
            document.getElementById('hitRate').textContent = data.hit_rate || '0%';
            document.getElementById('retryQueue').textContent = data.retry_queue_size || 0;

            // Update current status
            document.getElementById('currentMac').textContent = data.current_mac || '-';
            document.getElementById('currentProxy').textContent = data.current_proxy || '-';

            // Update status indicator
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('scannerStatus');
            
            if (data.paused) {
                statusIndicator.className = 'status-indicator status-paused';
                statusText.textContent = 'Paused';
                isPaused = true;
            } else if (isRunning) {
                statusIndicator.className = 'status-indicator status-running';
                statusText.textContent = 'Running';
                isPaused = false;
            } else {
                statusIndicator.className = 'status-indicator status-stopped';
                statusText.textContent = 'Stopped';
                isPaused = false;
            }

            // Update hits list
            updateHitsList(data.found_macs || []);

            // Update logs list
            updateLogsList(data.logs || []);

            // Update proxy stats
            updateProxyStats(data.proxy_stats || {});

            // Load MAC stats periodically
            if (Math.random() < 0.1) {
                loadMacStats();
            }

            // Update running attacks display
            updateRunningAttacksFromScanner(data);
        }

        // Update running attacks from scanner data
        function updateRunningAttacksFromScanner(data) {
            if (isRunning && !runningAttacks.has('current_scanner')) {
                // Add current scanner as running attack
                runningAttacks.set('current_scanner', {
                    id: 'current_scanner',
                    portal: {
                        name: 'Current Portal',
                        url: document.getElementById('attack-url').value || 'Unknown'
                    },
                    status: data.paused ? 'paused' : 'running',
                    stats: { 
                        tested: data.tested || 0, 
                        hits: data.hits || 0, 
                        errors: 0 
                    },
                    startTime: Date.now()
                });
                selectedAttackId = 'current_scanner';
            } else if (runningAttacks.has('current_scanner')) {
                // Update existing attack
                const attack = runningAttacks.get('current_scanner');
                attack.status = data.paused ? 'paused' : (isRunning ? 'running' : 'stopped');
                attack.stats = { 
                    tested: data.tested || 0, 
                    hits: data.hits || 0, 
                    errors: 0 
                };
                attack.portal.url = document.getElementById('attack-url').value || attack.portal.url;
            }

            if (!isRunning && runningAttacks.has('current_scanner')) {
                // Remove when stopped
                runningAttacks.delete('current_scanner');
                if (selectedAttackId === 'current_scanner') {
                    selectedAttackId = null;
                }
            }

            updateAttacksList();
        }

        // Update hits list
        function updateHitsList(hits) {
            const hitsList = document.getElementById('found-list');
            
            if (hits.length === 0) {
                hitsList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No hits yet. Start scanning to find valid MACs!</div>';
                return;
            }

            hitsList.innerHTML = hits.map(hit => `
                <div class="log-entry success">
                    <span class="time">${hit.time || 'N/A'}</span>
                    <strong>${hit.mac}</strong> - ${hit.expiry || 'Unknown'} - ${hit.channels || 0}ch${hit.has_de ? ' üá©üá™' : ''}
                </div>
            `).join('');

            hitsList.scrollTop = hitsList.scrollHeight;
        }

        // Update logs list
        function updateLogsList(logs) {
            const logsList = document.getElementById('attack-log');
            
            if (logs.length === 0) {
                logsList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Logs will appear here when scanner starts.</div>';
                return;
            }

            logsList.innerHTML = logs.map(log => `
                <div class="log-entry ${log.level}">
                    <span class="time">${log.time}</span>
                    ${log.message}
                </div>
            `).join('');

            logsList.scrollTop = logsList.scrollHeight;
        }

        // Update proxy statistics
        function updateProxyStats(stats) {
            const proxyStatsList = document.getElementById('proxy-stats-list');
            
            if (Object.keys(stats).length === 0) {
                proxyStatsList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No proxy statistics available yet.</div>';
                return;
            }

            proxyStatsList.innerHTML = Object.entries(stats).map(([proxy, data]) => `
                <div class="log-entry">
                    <strong>${proxy}</strong><br>
                    Success: ${data.success_rate} | Speed: ${data.avg_speed} | Requests: ${data.total_requests} | Fails: ${data.consecutive_fails}
                </div>
            `).join('');
        }

        // Scanner control functions
        async function startScanner() {
            try {
                const result = await apiCall('/api/start', { method: 'POST' });
                isRunning = true;
                console.log('Scanner started');
                showSuccessMessage('Scanner started successfully');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function stopScanner() {
            try {
                const result = await apiCall('/api/stop', { method: 'POST' });
                isRunning = false;
                console.log('Scanner stopped');
                showSuccessMessage('Scanner stopped');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function pauseScanner() {
            try {
                const result = await apiCall('/api/pause', { method: 'POST' });
                isPaused = result.paused;
                console.log('Scanner ' + (isPaused ? 'paused' : 'resumed'));
                showSuccessMessage('Scanner ' + (isPaused ? 'paused' : 'resumed'));
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        // Load MAC space statistics
        async function loadMacStats() {
            try {
                const stats = await apiCall('/api/mac_stats');
                document.getElementById('macCoverage').textContent = stats.coverage_percent + '%';
            } catch (error) {
                console.error('Error loading MAC stats:', error);
            }
        }

        // Configuration functions
        async function loadConfig() {
            try {
                const config = await apiCall('/api/config');
                
                document.getElementById('attack-url').value = config.portal_url || '';
                document.getElementById('setting-prefix').value = config.mac_prefix || '';
                document.getElementById('current-prefix').textContent = config.mac_prefix || '-';
                document.getElementById('current-portal').textContent = config.portal_url || '-';
                
                // Load proxy list
                const proxyList = document.getElementById('proxy-list');
                if (proxyList) {
                    proxyList.value = (config.proxies || []).join('\n');
                    document.getElementById('proxy-count').textContent = (config.proxies || []).length;
                }
                
                console.log('Configuration loaded');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function saveConfig() {
            const config = {
                portal_url: document.getElementById('attack-url').value,
                mac_prefix: document.getElementById('setting-prefix').value,
                proxies: document.getElementById('proxy-list').value.split('\n').filter(p => p.trim()),
                settings: {
                    max_workers: parseInt(document.getElementById('setting-max-workers').value),
                    chunk_size: parseInt(document.getElementById('setting-chunk-size').value),
                    timeout: parseInt(document.getElementById('setting-timeout').value),
                    debug_mode: document.getElementById('setting-debug-mode').checked,
                    max_retries: parseInt(document.getElementById('setting-max-retries').value),
                    auto_save: document.getElementById('setting-auto-save').checked,
                    quickscan_only: document.getElementById('setting-quickscan-only').checked,
                    connections_per_host: parseInt(document.getElementById('setting-connections-per-host').value),
                    requests_per_minute_per_proxy: parseInt(document.getElementById('setting-requests-per-minute').value),
                    min_delay_between_requests: parseFloat(document.getElementById('setting-min-delay').value)
                }
            };

            try {
                const result = await apiCall('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                showSuccessMessage('Configuration saved successfully!');
                console.log('Configuration saved');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const config = await apiCall('/api/config');
                const settings = config.settings || {};
                
                document.getElementById('setting-max-workers').value = settings.max_workers || 50;
                document.getElementById('setting-timeout').value = settings.timeout || 15;
                document.getElementById('setting-chunk-size').value = settings.chunk_size || 1000;
                document.getElementById('setting-debug-mode').checked = settings.debug_mode || false;
                document.getElementById('setting-auto-save').checked = settings.auto_save !== false;
                document.getElementById('setting-quickscan-only').checked = settings.quickscan_only || false;
                document.getElementById('setting-max-retries').value = settings.max_retries || 3;
                document.getElementById('setting-connections-per-host').value = settings.connections_per_host || 5;
                document.getElementById('setting-requests-per-minute').value = settings.requests_per_minute_per_proxy || 30;
                document.getElementById('setting-min-delay').value = settings.min_delay_between_requests || 0.5;
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Placeholder functions for new features (to be implemented)
        function loadPortals() {
            console.log('Loading portals...');
            apiCall('/api/portals')
                .then(portals => {
                    updatePortalsTable(portals);
                    updatePortalSelect(portals);
                })
                .catch(error => console.error('Error loading portals:', error));
        }

        function updatePortalsTable(portals) {
            const tbody = document.getElementById('portals-tbody');
            if (!tbody) return;

            if (portals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No portals saved yet</td></tr>';
                return;
            }

            tbody.innerHTML = portals.map(portal => `
                <tr>
                    <td><strong>${portal.name}</strong></td>
                    <td><code>${portal.url}</code></td>
                    <td>
                        <span class="status-badge ${portal.enabled ? 'enabled' : 'disabled'}">
                            ${portal.enabled ? 'Enabled' : 'Disabled'}
                        </span>
                    </td>
                    <td>
                        <div class="button-group">
                            <button class="btn btn-small ${portal.enabled ? 'btn-warning' : 'btn-success'}" 
                                    onclick="togglePortal(${portal.id})">
                                ${portal.enabled ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deletePortal(${portal.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updatePortalSelect(portals) {
            const select = document.getElementById('attack-portal-select');
            if (!select) return;

            select.innerHTML = '<option value="">-- Select Portal --</option>';
            portals.filter(p => p.enabled).forEach(portal => {
                select.innerHTML += `<option value="${portal.url}">${portal.name}</option>`;
            });
        }

        async function addPortal() {
            const name = document.getElementById('portal-name').value.trim();
            const url = document.getElementById('portal-url').value.trim();

            if (!name || !url) {
                showErrorMessage('Please enter both portal name and URL');
                return;
            }

            try {
                await apiCall('/api/portals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add', name, url })
                });

                document.getElementById('portal-name').value = '';
                document.getElementById('portal-url').value = '';
                showSuccessMessage('Portal added successfully');
                loadPortals();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function togglePortal(id) {
            try {
                await apiCall('/api/portals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'toggle', id })
                });

                showSuccessMessage('Portal status updated');
                loadPortals();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function deletePortal(id) {
            if (!confirm('Are you sure you want to delete this portal?')) {
                return;
            }

            try {
                await apiCall('/api/portals', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', id })
                });

                showSuccessMessage('Portal deleted');
                loadPortals();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        function loadMacLists() {
            console.log('Loading MAC lists...');
            loadMacList('1');
            loadMacList('2');
            updateMacListCounts();
        }

        async function loadMacList(listId) {
            try {
                const macs = await apiCall(`/api/maclist?list=${listId}`);
                const textarea = document.getElementById(`mac-list-textarea-${listId}`);
                if (textarea) {
                    textarea.value = macs.join('\n');
                }
                updateMacListCount(listId, macs.length);
            } catch (error) {
                console.error(`Error loading MAC list ${listId}:`, error);
            }
        }

        function updateMacListCount(listId, count) {
            const countElement = document.getElementById(`maclist-count-${listId}`);
            if (countElement) {
                countElement.textContent = count;
            }

            const selectCountElement = document.getElementById(`mac-list-${listId}-count`);
            if (selectCountElement) {
                selectCountElement.textContent = count;
            }
        }

        function updateMacListCounts() {
            loadMacList('1');
            loadMacList('2');
        }

        async function saveMacList(listId) {
            const textarea = document.getElementById(`mac-list-textarea-${listId}`);
            if (!textarea) return;

            const macs = textarea.value.split('\n')
                .map(mac => mac.trim())
                .filter(mac => mac.length > 0);

            try {
                await apiCall('/api/maclist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save', macs, list: listId })
                });

                showSuccessMessage(`MAC List ${listId} saved successfully`);
                updateMacListCount(listId, macs.length);
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function clearMacList(listId) {
            if (!confirm(`Are you sure you want to clear MAC List ${listId}?`)) {
                return;
            }

            try {
                await apiCall('/api/maclist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'clear', list: listId })
                });

                const textarea = document.getElementById(`mac-list-textarea-${listId}`);
                if (textarea) {
                    textarea.value = '';
                }

                showSuccessMessage(`MAC List ${listId} cleared`);
                updateMacListCount(listId, 0);
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function importMacFile() {
            const fileInput = document.getElementById('mac-file-input');
            const targetList = document.getElementById('import-target-list').value;
            
            if (!fileInput.files[0]) {
                showErrorMessage('Please select a file to import');
                return;
            }

            const file = fileInput.files[0];
            const progressDiv = document.getElementById('import-progress');
            const progressBar = document.getElementById('import-progress-bar');
            const statusDiv = document.getElementById('import-status');

            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            statusDiv.textContent = 'Reading file...';

            try {
                const text = await file.text();
                const lines = text.split('\n');
                
                statusDiv.textContent = 'Processing MACs...';
                progressBar.style.width = '50%';

                const macs = lines
                    .map(line => line.trim())
                    .filter(line => line.length > 0);

                statusDiv.textContent = 'Importing to server...';
                progressBar.style.width = '75%';

                const result = await apiCall('/api/maclist', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'import', macs, list: targetList })
                });

                progressBar.style.width = '100%';
                statusDiv.textContent = `Import complete: ${result.imported} MACs imported`;

                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);

                showSuccessMessage(`Imported ${result.imported} MACs to List ${targetList}`);
                loadMacList(targetList);
                fileInput.value = '';
            } catch (error) {
                progressDiv.style.display = 'none';
                showErrorMessage('Error importing file: ' + error.message);
            }
        }

        function loadFoundMacs() {
            console.log('Loading found MACs...');
            apiCall('/api/config')
                .then(config => {
                    updateFoundMacsTable(config.found_macs || []);
                    updateFoundMacCount(config.found_macs ? config.found_macs.length : 0);
                })
                .catch(error => console.error('Error loading found MACs:', error));
        }

        function updateFoundMacsTable(foundMacs) {
            const tbody = document.getElementById('found-tbody');
            if (!tbody) return;

            if (foundMacs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">No MACs found yet</td></tr>';
                return;
            }

            tbody.innerHTML = foundMacs.map(mac => `
                <tr>
                    <td><code>${mac.mac}</code></td>
                    <td>${mac.expiry || 'Unknown'}</td>
                    <td>${mac.channels || 0}</td>
                    <td>${mac.has_de ? 'üá©üá™' : '-'}</td>
                    <td><small>${mac.portal || '-'}</small></td>
                    <td><small>${(mac.genres || []).slice(0, 3).join(', ')}</small></td>
                    <td><small>${mac.found_at ? new Date(mac.found_at).toLocaleString() : '-'}</small></td>
                    <td>
                        <button class="btn btn-small btn-secondary" onclick="copyToClipboard('${mac.mac}')">Copy</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateFoundMacCount(count) {
            const countElement = document.getElementById('found-mac-count');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccessMessage('MAC address copied to clipboard');
            }).catch(() => {
                showErrorMessage('Failed to copy to clipboard');
            });
        }

        async function clearFoundMacs() {
            if (!confirm('Are you sure you want to clear all found MACs?')) {
                return;
            }

            try {
                const config = await apiCall('/api/config');
                config.found_macs = [];
                
                await apiCall('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                showSuccessMessage('Found MACs cleared');
                loadFoundMacs();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        function loadProxySources() {
            console.log('Loading proxy sources...');
            apiCall('/api/proxy_sources')
                .then(sources => {
                    const textarea = document.getElementById('proxy-sources');
                    if (textarea) {
                        textarea.value = sources.join('\n');
                    }
                })
                .catch(error => console.error('Error loading proxy sources:', error));
        }

        async function saveProxySources() {
            const textarea = document.getElementById('proxy-sources');
            if (!textarea) return;

            const sources = textarea.value.split('\n')
                .map(source => source.trim())
                .filter(source => source.length > 0);

            try {
                await apiCall('/api/proxy_sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'save', sources })
                });

                showSuccessMessage('Proxy sources saved');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function fetchProxies() {
            try {
                const result = await apiCall('/api/proxy_sources', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'fetch' })
                });

                showSuccessMessage(`Fetched ${result.fetched} new proxies (Total: ${result.total})`);
                loadProxyList();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        function loadProxyList() {
            console.log('Loading proxy list...');
            apiCall('/api/config')
                .then(config => {
                    const textarea = document.getElementById('proxy-list');
                    if (textarea) {
                        textarea.value = (config.proxies || []).join('\n');
                    }
                    updateProxyCount(config.proxies ? config.proxies.length : 0);
                })
                .catch(error => console.error('Error loading proxy list:', error));
        }

        function updateProxyCount(count) {
            const countElement = document.getElementById('proxy-count');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        async function saveProxyList() {
            const textarea = document.getElementById('proxy-list');
            if (!textarea) return;

            const proxies = textarea.value.split('\n')
                .map(proxy => proxy.trim())
                .filter(proxy => proxy.length > 0);

            try {
                const config = await apiCall('/api/config');
                config.proxies = proxies;
                
                await apiCall('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                showSuccessMessage('Proxy list saved');
                updateProxyCount(proxies.length);
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function importProxies() {
            const textarea = document.getElementById('proxy-import-textarea');
            const typeSelect = document.getElementById('proxy-import-type');
            
            if (!textarea || !typeSelect) return;

            const proxies = textarea.value.split('\n')
                .map(proxy => proxy.trim())
                .filter(proxy => proxy.length > 0);

            if (proxies.length === 0) {
                showErrorMessage('Please enter some proxies to import');
                return;
            }

            try {
                const result = await apiCall('/api/proxy_management', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'import', 
                        proxies, 
                        type: typeSelect.value 
                    })
                });

                showSuccessMessage(`Imported ${result.imported} proxies (Total: ${result.total})`);
                textarea.value = '';
                loadProxyList();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function testProxies() {
            try {
                await apiCall('/api/proxy_management', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'test' })
                });

                showSuccessMessage('Proxy testing started');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function autoDetectProxies() {
            try {
                await apiCall('/api/proxy_management', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'auto_detect' })
                });

                showSuccessMessage('Proxy auto-detection started');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function removeFailedProxies() {
            if (!confirm('Remove all failed proxies?')) {
                return;
            }

            try {
                await apiCall('/api/proxy_management', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'remove_failed' })
                });

                showSuccessMessage('Failed proxies removed');
                loadProxyList();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function resetProxyErrors() {
            try {
                await apiCall('/api/proxy_management', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'reset_errors' })
                });

                showSuccessMessage('Proxy errors reset');
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function clearAllProxies() {
            if (!confirm('Clear all proxies?')) {
                return;
            }

            try {
                await apiCall('/api/proxy_management', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'clear_all' })
                });

                showSuccessMessage('All proxies cleared');
                loadProxyList();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        // Export functions
        async function exportHits(format) {
            try {
                const response = await fetch(`/api/export_hits?format=${format}`);
                
                if (format === 'txt') {
                    const text = await response.text();
                    downloadFile('macattack_hits.txt', text, 'text/plain');
                } else {
                    const json = await response.json();
                    downloadFile('macattack_hits.json', JSON.stringify(json, null, 2), 'application/json');
                }
                showSuccessMessage(`Hits exported as ${format.toUpperCase()}`);
            } catch (error) {
                showErrorMessage('Error exporting hits: ' + error.message);
            }
        }

        function downloadFile(filename, content, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('btn-start').addEventListener('click', startScanner);
        document.getElementById('btn-stop-all').addEventListener('click', stopScanner);
        document.getElementById('btn-pause').addEventListener('click', pauseScanner);
        document.getElementById('btn-save-settings').addEventListener('click', saveConfig);
        document.getElementById('btn-save-performance-settings').addEventListener('click', saveConfig);
        document.getElementById('btn-export-txt').addEventListener('click', () => exportHits('txt'));
        document.getElementById('btn-export-json').addEventListener('click', () => exportHits('json'));

        // Portal management event listeners
        document.getElementById('btn-add-portal').addEventListener('click', addPortal);

        // MAC list management event listeners
        document.querySelectorAll('.btn-save-maclist').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const listId = e.target.dataset.list;
                saveMacList(listId);
            });
        });

        document.querySelectorAll('.btn-clear-maclist').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const listId = e.target.dataset.list;
                clearMacList(listId);
            });
        });

        document.getElementById('btn-import-file').addEventListener('click', importMacFile);

        // Found MACs event listeners
        document.getElementById('btn-clear-found').addEventListener('click', clearFoundMacs);

        // Proxy management event listeners
        document.getElementById('btn-save-sources').addEventListener('click', saveProxySources);
        document.getElementById('btn-fetch-proxies').addEventListener('click', fetchProxies);
        document.getElementById('btn-save-proxies').addEventListener('click', saveProxyList);
        document.getElementById('btn-import-proxies').addEventListener('click', importProxies);
        document.getElementById('btn-test-proxies').addEventListener('click', testProxies);
        document.getElementById('btn-test-autodetect').addEventListener('click', autoDetectProxies);
        document.getElementById('btn-remove-failed').addEventListener('click', removeFailedProxies);
        document.getElementById('btn-reset-errors').addEventListener('click', resetProxyErrors);
        document.getElementById('btn-clear-proxies').addEventListener('click', clearAllProxies);

        // File input change handler
        document.getElementById('mac-file-input').addEventListener('change', (e) => {
            const fileInfo = document.getElementById('file-info');
            if (e.target.files[0]) {
                const file = e.target.files[0];
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                fileInfo.textContent = `${file.name} (${sizeMB} MB)`;
            } else {
                fileInfo.textContent = '';
            }
        });

        // Portal select change handler
        document.getElementById('attack-portal-select').addEventListener('change', (e) => {
            if (e.target.value) {
                document.getElementById('attack-url').value = e.target.value;
            }
        });

        // Multi-portal attack event listeners
        document.getElementById('btn-start-multi').addEventListener('click', startMultiPortalAttack);
        document.getElementById('btn-clear-finished').addEventListener('click', clearFinishedAttacks);

        // Logout function
        async function logout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }

            try {
                const result = await apiCall('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        document.getElementById('btn-logout').addEventListener('click', logout);

        // Multi-Portal Attack System
        let runningAttacks = new Map();

        async function startMultiPortalAttack() {
            try {
                const portals = await apiCall('/api/portals');
                const enabledPortals = portals.filter(p => p.enabled);

                if (enabledPortals.length === 0) {
                    showErrorMessage('No enabled portals found');
                    return;
                }

                for (const portal of enabledPortals) {
                    await startPortalAttack(portal);
                }

                showSuccessMessage(`Started attacks on ${enabledPortals.length} portals`);
                updateAttacksList();
            } catch (error) {
                // Error already handled by apiCall
            }
        }

        async function startPortalAttack(portal) {
            const attackId = `attack_${portal.id}_${Date.now()}`;
            
            runningAttacks.set(attackId, {
                id: attackId,
                portal: portal,
                status: 'running',
                stats: { tested: 0, hits: 0, errors: 0 },
                startTime: Date.now()
            });

            // Start the actual attack (this would integrate with the existing scanner)
            // For now, we'll simulate it
            console.log(`Starting attack on portal: ${portal.name} (${portal.url})`);
        }

        function updateAttacksList() {
            const attacksList = document.getElementById('attacks-list');
            if (!attacksList) return;

            if (runningAttacks.size === 0) {
                attacksList.innerHTML = '<div class="no-attacks">No attacks running</div>';
                return;
            }

            attacksList.innerHTML = Array.from(runningAttacks.values()).map(attack => `
                <div class="attack-item ${selectedAttackId === attack.id ? 'selected' : ''}" 
                     onclick="selectAttack('${attack.id}')">
                    <div class="attack-info">
                        <div class="attack-url">${attack.portal.name}</div>
                        <div class="attack-stats">
                            Tested: ${attack.stats.tested} | Hits: ${attack.stats.hits} | Errors: ${attack.stats.errors}
                        </div>
                    </div>
                    <div class="attack-actions">
                        <button class="btn btn-small btn-warning" onclick="pauseAttack('${attack.id}')">Pause</button>
                        <button class="btn btn-small btn-danger" onclick="stopAttack('${attack.id}')">Stop</button>
                    </div>
                </div>
            `).join('');
        }

        function selectAttack(attackId) {
            selectedAttackId = attackId;
            updateAttacksList();
            
            const attack = runningAttacks.get(attackId);
            if (attack) {
                // Update attack details view
                document.getElementById('current-portal').textContent = attack.portal.url;
                document.getElementById('stat-tested').textContent = attack.stats.tested;
                document.getElementById('stat-hits').textContent = attack.stats.hits;
                document.getElementById('stat-errors').textContent = attack.stats.errors;
                
                // Show attack details
                document.getElementById('attack-details').style.display = 'block';
            }
        }

        function pauseAttack(attackId) {
            const attack = runningAttacks.get(attackId);
            if (attack) {
                attack.status = attack.status === 'paused' ? 'running' : 'paused';
                console.log(`Attack ${attackId} ${attack.status}`);
                updateAttacksList();
            }
        }

        function stopAttack(attackId) {
            runningAttacks.delete(attackId);
            if (selectedAttackId === attackId) {
                selectedAttackId = null;
                document.getElementById('attack-details').style.display = 'none';
            }
            updateAttacksList();
            console.log(`Attack ${attackId} stopped`);
        }

        function clearFinishedAttacks() {
            const finishedAttacks = Array.from(runningAttacks.entries())
                .filter(([id, attack]) => attack.status === 'finished');
            
            finishedAttacks.forEach(([id]) => {
                runningAttacks.delete(id);
            });

            updateAttacksList();
            showSuccessMessage(`Cleared ${finishedAttacks.length} finished attacks`);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadMacStats();
            socket.emit('request_update');
        });
    </script>
</body>
</html>